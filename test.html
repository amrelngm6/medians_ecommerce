<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Channel Player with Partial Loading</title>
</head>
<body>
    <video id="videoPlayer" controls>
        Your browser does not support the video tag.
    </video>

    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const channelId = 1; // Replace with the desired channel ID

        function fetchCurrentVideoInfo() {
            fetch(`/channel_json/`+channelId)
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        loadVideoPartially(data.active_item);
                    } else {
                        console.log('No video currently playing');
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function loadVideoPartially(media) {
            console.log(media)
            
            var a = new Date(media.start);
            var b = new Date();
            var difference = parseInt((b - a) / 1000);
            const videoUrl = '/test.php?v='+media.media.filepath.filename;
            const mediaSource = new MediaSource();
            videoPlayer.src = URL.createObjectURL(mediaSource);

            mediaSource.addEventListener('sourceopen', function() {
                const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E, mp4a.40.2"');
                fetchVideoChunk(videoUrl, difference, sourceBuffer);
            });

            videoPlayer.currentTime = difference;
        }

        function fetchVideoChunk(url, startByte, sourceBuffer, chunkSize = 1024 * 1024) {
            fetch(url, {
                headers: {
                    'Range': `bytes=${startByte}-${startByte + chunkSize - 1}`
                }
            })
            .then(response => response.arrayBuffer())
            .then(data => {
                sourceBuffer.appendBuffer(data);
                if (videoPlayer.readyState >= 3) { // HAVE_FUTURE_DATA or higher
                    videoPlayer.play();
                }
                // Fetch next chunk
                fetchVideoChunk(url, startByte + chunkSize, sourceBuffer, chunkSize);
            })
            .catch(error => console.error('Error fetching video chunk:', error));
        }

        // Fetch video info when the page loads
        fetchCurrentVideoInfo();

        // Periodically check for updates (e.g., every 5 minutes)
        setInterval(fetchCurrentVideoInfo, 5 * 60 * 1000);
    </script>
</body>
</html>